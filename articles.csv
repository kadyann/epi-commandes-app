N¬∞ R√©f√©rence,Nom,Description,Prix,Unit√©e
40953,Chaussure de s√©curit√© JALAS Taille 36,Chaussures,99.90,Par paire
40954,Chaussure de s√©curit√© JALAS Taille 37,Chaussures,99.90,Par paire
40955,Chaussure de s√©curit√© JALAS Taille 38,Chaussures,99.90,Par paire
40956,Chaussure de s√©curit√© JALAS Taille 39,Chaussures,99.90,Par paire
40957,Chaussure de s√©curit√© JALAS Taille 40,Chaussures,99.90,Par paire
40958,Chaussure de s√©curit√© JALAS Taille 41,Chaussures,99.90,Par paire
40959,Chaussure de s√©curit√© JALAS Taille 42,Chaussures,99.90,Par paire
40960,Chaussure de s√©curit√© JALAS Taille 43,Chaussures,99.90,Par paire
40961,Chaussure de s√©curit√© JALAS Taille 44,Chaussures,99.90,Par paire
40962,Chaussure de s√©curit√© JALAS Taille 45,Chaussures,99.90,Par paire
40963,Chaussure de s√©curit√© JALAS Taille 46,Chaussures,99.90,Par paire
40964,Chaussure de s√©curit√© JALAS Taille 47,Chaussures,99.90,Par paire
40965,Chaussure de s√©curit√© JALAS Taille 48,Chaussures,99.90,Par paire
40966,Chaussure de s√©curit√© JALAS Taille 49,Chaussures,99.90,Par paire
40902,Chaussure de s√©curit√© DIADORA Taille 36,Chaussures,107.40,Par paire
40903,Chaussure de s√©curit√© DIADORA Taille 37,Chaussures,107.40,Par paire
40904,Chaussure de s√©curit√© DIADORA Taille 38,Chaussures,107.40,Par paire
40905,Chaussure de s√©curit√© DIADORA Taille 39,Chaussures,107.40,Par paire
40906,Chaussure de s√©curit√© DIADORA Taille 40,Chaussures,107.40,Par paire
40907,Chaussure de s√©curit√© DIADORA Taille 41,Chaussures,107.40,Par paire
40908,Chaussure de s√©curit√© DIADORA Taille 42,Chaussures,113.00,Par paire
40909,Chaussure de s√©curit√© DIADORA Taille 43,Chaussures,113.00,Par paire
40910,Chaussure de s√©curit√© DIADORA Taille 44,Chaussures,107.40,Par paire
40911,Chaussure de s√©curit√© DIADORA Taille 45,Chaussures,113.00,Par paire
40912,Chaussure de s√©curit√© DIADORA Taille 46,Chaussures,113.00,Par paire
40913,Chaussure de s√©curit√© DIADORA Taille 47,Chaussures,107.40,Par paire
40914,Chaussure de s√©curit√© DIADORA Taille 48,Chaussures,107.40,Par paire
40915,Protection M√©tacarpe,Chaussures,17.49,Par paire
31853,Semelle UVEX Hydroflex Gel Taille 38,Chaussures,10.22,Par paire
32659,Semelle UVEX Hydroflex Gel Taille 39,Chaussures,10.22,Par paire
31854,Semelle UVEX Hydroflex Gel Taille 40,Chaussures,10.22,Par paire
31855,Semelle UVEX Hydroflex Gel Taille 41,Chaussures,10.22,Par paire
31856,Semelle UVEX Hydroflex Gel Taille 42,Chaussures,10.22,Par paire
32660,Semelle UVEX Hydroflex Gel Taille 43,Chaussures,10.22,Par paire
31857,Semelle UVEX Hydroflex Gel Taille 44,Chaussures,10.22,Par paire
32661,Semelle UVEX Hydroflex Gel Taille 45,Chaussures,10.22,Par paire
32662,Semelle UVEX Hydroflex Gel Taille 46,Chaussures,10.22,Par paire
32663,Semelle UVEX Hydroflex Gel Taille 47,Chaussures,10.22,Par paire
32664,Semelle UVEX Hydroflex Gel Taille 48,Chaussures,10.22,Par paire
39968,Semelle ATLAS Klima Confort Taille 36,Chaussures,4.90,Par paire
39969,Semelle ATLAS Klima Confort Taille 37,Chaussures,4.90,Par paire
39970,Semelle ATLAS Klima Confort Taille 38,Chaussures,4.90,Par paire
39971,Semelle ATLAS Klima Confort Taille 39,Chaussures,4.90,Par paire
39972,Semelle ATLAS Klima Confort Taille 40,Chaussures,4.90,Par paire
39973,Semelle ATLAS Klima Confort Taille 41,Chaussures,4.90,Par paire
39974,Semelle ATLAS Klima Confort Taille 42,Chaussures,4.90,Par paire
39975,Semelle ATLAS Klima Confort Taille 43,Chaussures,4.90,Par paire
39976,Semelle ATLAS Klima Confort Taille 44,Chaussures,4.90,Par paire
39977,Semelle ATLAS Klima Confort Taille 45,Chaussures,4.90,Par paire
39978,Semelle ATLAS Klima Confort Taille 46,Chaussures,4.90,Par paire
39979,Semelle ATLAS Klima Confort Taille 47,Chaussures,4.90,Par paire
39980,Semelle ATLAS Klima Confort Taille 48,Chaussures,4.90,Par paire
39981,Semelle ATLAS Klima Confort Taille 49,Chaussures,4.90,Par paire
36610,Lacets pour chaussures 150 Cm,Chaussures,3.17,Par paquet
34528,Blouson Orange Taille S,Veste Blouson,105.00,Par Veste
34534,Blouson Orange Taille M,Veste Blouson,105.00,Par Veste
34535,Blouson Orange Taille L,Veste Blouson,105.00,Par Veste
34536,Blouson Orange Taille XL,Veste Blouson,105.00,Par Veste
34537,Blouson Orange Taille XXL,Veste Blouson,105.00,Par Veste
34538,Blouson Orange Taille XXXL,Veste Blouson,105.00,Par Veste
38815,Sous Veste Bleu Taille S,Sous Veste,55.50,Par sous Veste
38816,Sous Veste Bleu Taille M,Sous Veste,55.50,Par sous Veste
38817,Sous Veste Bleu Taille L,Sous Veste,55.50,Par sous Veste
38818,Sous Veste Bleu Taille XL,Sous Veste,55.50,Par sous Veste
38819,Sous Veste Bleu Taille XXL,Sous Veste,55.50,Par sous Veste
38820,Sous Veste Bleu Taille XXXL,Sous Veste,55.50,Par sous Veste
33429,Veste en cuir Oxycoupage Taille 48,Veste Oxycoupeur,127.14,Par Veste
33430,Veste en cuir Oxycoupage Taille 50,Veste Oxycoupeur,129.00,Par Veste
33431,Veste en cuir Oxycoupage Taille 52,Veste Oxycoupeur,129.80,Par Veste
33432,Veste en cuir Oxycoupage Taille 54,Veste Oxycoupeur,131.25,Par Veste
33433,Veste en cuir Oxycoupage Taille 56,Veste Oxycoupeur,136.87,Par Veste
33434,Veste en cuir Oxycoupage Taille 58,Veste Oxycoupeur,139.31,Par Veste
33435,Veste en cuir Oxycoupage Taille 60,Veste Oxycoupeur,142.87,Par Veste
33436,Veste en cuir Oxycoupage Taille 62,Veste Oxycoupeur,148.12,Par Veste
33437,Veste en cuir Oxycoupage Taille 64,Veste Oxycoupeur,163.50,Par Veste
39750,Gilet de signalisation Jaune Taille M,S√©curit√©,1.48,Par Gilet
39751,Gilet de signalisation Jaune Taille L,S√©curit√©,2.10,Par Gilet
39752,Gilet de signalisation Jaune Taille XL,S√©curit√©,2.80,Par Gilet
39753,Gilet de signalisation Jaune Taille XXL,S√©curit√©,2.80,Par Gilet
977,Gilet Brun sans manche,Sous Veste,22.67,Par Gilet
e-catalogue,Veste chauffante BOSCH,Veste Blouson,225.00,Par Veste
41074,Gants RIG ROG Taille 8,Gants,8.80,La paire
41075,Gants RIG ROG Taille 9,Gants,8.80,La paire
41076,Gants RIG ROG Taille 10,Gants,8.80,La paire
41077,Gants RIG ROG Taille 11,Gants,8.80,La paire
40879,Gants Docker GUYARD Taille 8,Gants,1.98,La paire
40880,Gants Docker GUYARD Taille 9,Gants,1.98,La paire
40881,Gants Docker GUYARD Taille 10,Gants,2.03,La paire
40882,Gants Docker GUYARD Taille 11,Gants,2.03,La paire
40305,Anti coupure Lebon Wintersafe Taille 8,Gants,7.08,La paire
40306,Anti coupure Lebon Wintersafe Taille 9,Gants,7.08,La paire
40307,Anti coupure Lebon Wintersafe Taille 10,Gants,7.08,La paire
40308,Anti coupure Lebon Wintersafe Taille 11,Gants,7.08,La paire
39491,Anti coupure Lebon Metalfit Taille 7,Gants,6.20,La paire
39492,Anti coupure Lebon Metalfit Taille 8,Gants,6.20,La paire
39493,Anti coupure Lebon Metalfit Taille 9,Gants,6.20,La paire
39494,Anti coupure Lebon Metalfit Taille 10,Gants,6.20,La paire
39495,Anti coupure Lebon Metalfit Taille 11,Gants,6.20,La paire
37890,Gants Anti chaleur ESPUNA Brun Long 15 Cm Taille 9,Gants,40.00,La paire
26009,Gants Anti chaleur ESPUNA Brun Long 15 Cm Taille 10,Gants,40.00,La paire
26010,Gants Anti chaleur ESPUNA Brun Long 15 Cm Taille 11,Gants,40.00,La paire
27158,Gants Anti chaleur ESPUNA Brun Long 15 Cm Taille 12,Gants,40.00,La paire
34374,Gants Anti chaleur ESPUNA Gris Long 25 Cm Taille 8,Gants,28.00,La paire
34375,Gants Anti chaleur ESPUNA Gris Long 25 Cm Taille 9,Gants,28.00,La paire
34377,Gants Anti chaleur ESPUNA Gris Long 25 Cm Taille 11,Gants,28.00,La paire
34038,Manchette,Gants,10.25,La paire
40862,Gants Anti chaleur ALUMINISES Taille 9,Gants,56.00,La paire
40863,Gants Anti chaleur ALUMINISES Taille 10,Gants,56.00,La paire
40864,Gants Anti chaleur ALUMINISES Taille 11,Gants,56.00,La paire
37386,Boll√© Transparente TRACPSI,Lunette,10.50,Par unit√©e
38803,Deltaplus Transparente PACAYA,Lunette,10.50,Par unit√©e
40989,AMBRIC TPE 49100 Transparente,Lunette,10.50,Par unit√©e
40326,Sur lunette de protection,Lunette,10.50,Par unit√©e
41415,Boll√© COBRA Transparente,Lunette,10.50,Par unit√©e
33961,Lunette Boll√© Transparente,Lunette,7.98,Par unit√©e
34527,Pantalon de signalisation Orange Taille S,Pantalon,73.58,Par unit√©e
34529,Pantalon de signalisation Orange Taille M,Pantalon,73.58,Par unit√©e
34530,Pantalon de signalisation Orange Taille L,Pantalon,73.58,Par unit√©e
34531,Pantalon de signalisation Orange Taille XL,Pantalon,73.58,Par unit√©e
34532,Pantalon de signalisation Orange Taille XXL,Pantalon,73.58,Par unit√©e
34533,Pantalon de signalisation Orange Taille XXXL,Pantalon,73.58,Par unit√©e
e-catalogue,Lunette Oxycoupage ULTRASONIC MASQUE T5,Lunette,33.80,Par unit√©e
30552,Cagoule ignifug√©,Protection,29.00,Par unit√©e
40428,Cache cou Fire resistant BUFF,Protection,28.70,Par unit√©e
33895,Tablier en cuir soudage OXY MEUL 110X80Cm,Protection,44.00,Par unit√©e
33451,Gu√™tre en cuir,Protection,36.90,Par unit√©e
41376,Gu√™tre Aluminis√© Taille 36/38,Protection,126.90,Par unit√©e
41377,Gu√™tre Aluminis√© Taille 39/40,Protection,126.90,Par unit√©e
41378,Gu√™tre Aluminis√© Taille 41/42,Protection,126.90,Par unit√©e
41379,Gu√™tre Aluminis√© Taille 43/44,Protection,126.90,Par unit√©e
41380,Gu√™tre Aluminis√© Taille 45/46,Protection,126.90,Par unit√©e
41381,Gu√™tre Aluminis√© Taille 47/48,Protection,126.90,Par unit√©e
6147,Cl√© √† molette 10",Oxycoupage,16.41,Par unit√©e
75661,Collier de sertissage 15/18,Oxycoupage,0.24,Par unit√©e
41200,Filtre 3M,Protection,110.00,Par paquet
7103,Allumeur Gaz,Oxycoupage,4.50,Par unit√©e
7049,Brosse m√©tallique,Oxycoupage,1.50,Par unit√©e
334,Casque Polyester Blanc Gr 2,Casque,22.99,Par casque
335,Casque Polyester Blanc Gr 3,Casque,22.99,Par casque
40844,Casque Polyester Vert,Casque,22.99,Par casque
38522,Casque Polyester Jaune,Casque,16.30,Par casque
362,Jugulaire,Casque,7.99,Par unit√©e
6746,Craie Grasse MARKAL TYPE B Blanc,Marquage,1.62,Par Unit√©
6742,Stylo FIXOLID Blanc,Marquage,4.55,Par stylo
e-catalogue,Stylo marqueur peinture Edding,Marquage,3.10,Par stylo
e-catalogue,Craie Industriel Edding 95,Marquage,3.13,Par Unit√©
35427,Pot de peinture Couleur Jaune,Marquage,10.00,Par pot
38282,Pot de peinture Couleur Orange,Marquage,10.00,Par pot
38280,Pot de peinture Couleur Rouge,Marquage,10.00,Par pot
38374,Pot de peinture Couleur Violet,Marquage,10.00,Par pot
39680,Pot de peinture Couleur Lila,Marquage,10.00,Par pot
38279,Pot de peinture Couleur Bleu,Marquage,10.00,Par pot
38281,Pot de peinture Couleur Vert,Marquage,10.00,Par pot
39681,Pot de peinture Couleur Brun,Marquage,10.00,Par pot
38283,Pot de peinture Couleur Blanc,Marquage,10.00,Par pot
38284,Pot de peinture Couleur Noir,Marquage,10.00,Par pot
29755,Peinture en spray Couleur Rouge,Marquage,6.89,Par spray
29756,Peinture en spray Couleur Vert,Marquage,6.89,Par spray
29758,Peinture en spray Couleur Jaune,Marquage,6.89,Par spray
32599,Peinture en spray Couleur Blanc,Marquage,6.89,Par spray
32600,Peinture en spray Couleur Orange,Marquage,6.89,Par spray
29757,Peinture en spray Couleur Bleu,Marquage,6.89,Par spray
32598,Peinture en spray Couleur Noir,Marquage,6.89,Par spray
6692,Pinceau √† virole Rond Diam. 35mm,Marquage,2.05,Par Unit√©
36020,Pinceau S550 50mm,Marquage,4.15,Par Unit√©
6510,Marteau Ajusteur 1Kg,Outil,19.12,Par unit√©e
6461,Couteau √† lame retractable Edding M18,Outil,5.29,Par unit√©e
3930,M√®tre pliant en bois 2M,Outil,2.21,Par unit√©e
7125,Trousse Outil 430X260X160,Outil,36.93,Par unit√©e
6147,Cl√© Molette 10",Outil,16.41,Par unit√©e
33231,Jeu de tournevis Gamme Enduro,Outil,59.00,Par Jeu
6146,Cl√© √† molette 8",Outil,13.60,Par unit√©e
35991,Composition maintenance en trousse FACOM,Outil,216.97,Par unit√©e
281,Couteau √©lectricien 2 Lames,Outil,18.51,Par unit√©e
40240,Lampe Frontale Rechargeable LED LENSER H7R,Lampe,84.50,Par unit√©e
38608,Lampe torche LED LENSER M7R,Lampe,99.83,Par unit√©e
e-catalogue,Lampe torche LED LENSER P7R Rechargeable,Lampe,73.27,Par unit√©e

def validate_article_data(article):
    """Valide les donn√©es d'un article"""
    errors = []
    
    if not article.get('Nom') or len(article['Nom'].strip()) < 3:
        errors.append("Le nom doit contenir au moins 3 caract√®res")
    
    try:
        prix = float(article.get('Prix', 0))
        if prix <= 0:
            errors.append("Le prix doit √™tre sup√©rieur √† 0")
        if prix > 10000:
            errors.append("Le prix semble anormalement √©lev√©")
    except:
        errors.append("Le prix doit √™tre un nombre valide")
    
    if not article.get('Cat√©gorie'):
        errors.append("La cat√©gorie est obligatoire")
    
    return errors

def show_notifications():
    """Affiche les notifications utilisateur"""
    user_info = st.session_state.get('current_user', {})
    
    # Notifications pour les contrema√Ætres
    if user_info.get('role') != 'admin':
        # V√©rifier si proche de la limite budg√©taire
        cart_total = sum(float(item['Prix']) for item in st.session_state.cart)
        if cart_total > MAX_CART_AMOUNT * 0.8:  # 80% de la limite
            st.warning(f"‚ö†Ô∏è Attention : Vous approchez de la limite budg√©taire ({cart_total:.2f}‚Ç¨ / {MAX_CART_AMOUNT}‚Ç¨)")

def generate_order_pdf(commande_data):
    """G√©n√®re un PDF professionnel pour une commande"""
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4)
    
    # En-t√™te avec logo FLUX/PARA
    story = []
    
    # Titre
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=getSampleStyleSheet()['Heading1'],
        fontSize=18,
        spaceAfter=30,
        textColor=colors.HexColor('#2563eb')
    )
    
    story.append(Paragraph("üõ°Ô∏è FLUX/PARA - Bon de commande", title_style))
    story.append(Spacer(1, 20))
    
    # Informations commande
    info_data = [
        ['Commande N¬∞:', commande_data['id']],
        ['Date:', commande_data['date']],
        ['Contrema√Ætre:', commande_data['contrema√Ætre']],
        ['√âquipe:', commande_data['equipe']],
        ['Total:', f"{commande_data['total_prix']:.2f}‚Ç¨"]
    ]
    
    info_table = Table(info_data, colWidths=[3*inch, 3*inch])
    info_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#f8fafc')),
        ('TEXTCOLOR', (0, 0), (-1, -1), colors.black),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('FONTNAME', (0, 0), (-1, -1), 'Helvetica'),
        ('FONTSIZE', (0, 0), (-1, -1), 10),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
        ('GRID', (0, 0), (-1, -1), 1, colors.black)
    ]))
    
    story.append(info_table)
    story.append(Spacer(1, 30))
    
    # Articles command√©s
    articles = json.loads(commande_data['articles_json'])
    grouped_articles = grouper_articles_panier(articles)
    
    articles_data = [['Article', 'Quantit√©', 'Prix unitaire', 'Total']]
    
    for group in grouped_articles:
        article = group['article']
        quantite = group['quantite']
        prix_unitaire = float(article['Prix'])
        total_ligne = prix_unitaire * quantite
        
        articles_data.append([
            article['Nom'],
            str(quantite),
            f"{prix_unitaire:.2f}‚Ç¨",
            f"{total_ligne:.2f}‚Ç¨"
        ])
    
    articles_table = Table(articles_data, colWidths=[3*inch, 1*inch, 1.5*inch, 1.5*inch])
    articles_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2563eb')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black)
    ]))
    
    story.append(Paragraph("Articles command√©s:", getSampleStyleSheet()['Heading2']))
    story.append(articles_table)
    
    doc.build(story)
    buffer.seek(0)
    return buffer

def show_advanced_search():
    """Affiche les options de recherche avanc√©e"""
    with st.expander("üîç Recherche avanc√©e"):
        col1, col2, col3 = st.columns(3)
        
        with col1:
            prix_min = st.number_input("Prix minimum (‚Ç¨)", min_value=0.0, value=0.0)
            prix_max = st.number_input("Prix maximum (‚Ç¨)", min_value=0.0, value=1000.0)
        
        with col2:
            categories = articles_df['Cat√©gorie'].unique().tolist() if not articles_df.empty else []
            selected_categories = st.multiselect("Cat√©gories", categories)
        
        with col3:
            sort_by = st.selectbox("Trier par", ["Nom", "Prix croissant", "Prix d√©croissant", "Cat√©gorie"])
        
        return {
            'prix_min': prix_min,
            'prix_max': prix_max,
            'categories': selected_categories,
            'sort_by': sort_by
        }

def show_admin_dashboard():
    """Dashboard administrateur avec m√©triques cl√©s"""
    st.markdown("### üìä Dashboard Administrateur")
    
    # M√©triques rapides
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        nb_users = get_total_users()
        st.metric("üë• Utilisateurs", nb_users)
    
    with col2:
        nb_commandes_mois = get_orders_this_month()
        st.metric("üì¶ Commandes ce mois", nb_commandes_mois)
    
    with col3:
        montant_mois = get_amount_this_month()
        st.metric("üí∞ CA ce mois", f"{montant_mois:.2f}‚Ç¨")
    
    with col4:
        nb_articles = len(articles_df)
        st.metric("üõ°Ô∏è Articles catalogue", nb_articles)
    
    # Graphiques de tendances
    col1, col2 = st.columns(2)
    
    with col1:
        # Top 5 des contrema√Ætres actifs
        show_top_users_chart()
    
    with col2:
        # √âvolution des commandes sur 30 jours
        show_orders_trend_chart()

def backup_database():
    """Cr√©e une sauvegarde de la base de donn√©es"""
    try:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        if USE_POSTGRESQL:
            # Backup PostgreSQL
            backup_filename = f"backup_postgres_{timestamp}.sql"
            # Commande pg_dump ici
        else:
            # Backup SQLite
            backup_filename = f"backup_sqlite_{timestamp}.db"
            shutil.copy2(DATABASE_PATH, backup_filename)
        
        return backup_filename
    except Exception as e:
        st.error(f"Erreur sauvegarde: {e}")
        return None
